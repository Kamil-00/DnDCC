@using System.Linq
@using System.Text.Json
@model Projekt.Model.DataModels.Character
@{
    ViewData["Title"] = Model.Name;
    var profs = ViewData["Proficiencies"] as IList<string> ?? new List<string>();
    var traits = ViewData["Traits"] as IList<string> ?? new List<string>();
    Func<int, string> formatMod = score =>
    {
        var mod = (int)Math.Floor((score - 10) / 2.0);
        return mod >= 0 ? $"+{mod}" : mod.ToString();
    };
    var profText = string.Join(", ", profs);
    var traitText = string.Join(", ", traits);
    var equipmentText = Model.Items != null && Model.Items.Any()
        ? string.Join(", ", Model.Items.Select(i => $"{i.Name} × {i.Quantity}"))
        : string.Empty;
    var pdfFields = new Dictionary<string, string>
    {
        ["CharacterName"] = Model.Name ?? string.Empty,
        ["ClassLevel"] = Model.Class ?? string.Empty,
        ["Race "] = Model.Race ?? string.Empty,
        ["Alignment"] = Model.Alignment ?? string.Empty,
        ["HPMax"] = Model.MaxHP.ToString(),
        ["HPCurrent"] = Model.CurrentHP.ToString(),
        ["HPTemp"] = Model.TemporaryHP.ToString(),
        ["AC"] = Model.ArmorClass.ToString(),
        ["Speed"] = Model.Speed.ToString(),
        ["STR"] = Model.Strength.ToString(),
        ["DEX"] = Model.Dexterity.ToString(),
        ["CON"] = Model.Constitution.ToString(),
        ["INT"] = Model.Intelligence.ToString(),
        ["WIS"] = Model.Wisdom.ToString(),
        ["CHA"] = Model.Charisma.ToString(),
        ["STRmod"] = formatMod(Model.Strength),
        ["DEXmod "] = formatMod(Model.Dexterity),
        ["CONmod"] = formatMod(Model.Constitution),
        ["INTmod"] = formatMod(Model.Intelligence),
        ["WISmod"] = formatMod(Model.Wisdom),
        ["CHamod"] = formatMod(Model.Charisma),
        ["ProficienciesLang"] = profText,
        ["Features and Traits"] = traitText,
        ["Equipment"] = equipmentText,
        ["AttacksSpellcasting"] = Model.Notes ?? string.Empty
    };
}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-sm uppercase tracking-wide text-amber-700">Karta postaci</p>
            <h1 class="title-font text-3xl text-amber-900">@Model.Name</h1>
            <p class="text-amber-800">@Model.Race • @Model.Class • @Model.Alignment</p>
        </div>
        <div class="text-right text-sm text-amber-900">
            <div>HP: @Model.CurrentHP / @Model.MaxHP</div>
            <div>AC: @Model.ArmorClass • Speed: @Model.Speed</div>
        </div>
    </div>

    <div class="bg-amber-50 border border-amber-900/20 rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
            <h3 class="title-font text-lg text-amber-900">Awatar</h3>
            <p class="text-sm text-amber-800">Wygeneruj portret bohatera z DALL·E.</p>
        </div>
        <div class="flex items-center gap-3">
            <img id="avatarPreview" src="/images/avatars/avatar_@(Model.Id).png" class="w-24 h-24 object-cover rounded-lg border border-amber-900/30 hidden" alt="Awatar">
            <button id="generateAvatar" class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold border border-amber-900/30">
                Wygeneruj awatar
            </button>
        </div>
    </div>
    <div class="flex flex-wrap justify-end gap-2">
        <button type="button" id="downloadCharacterPdf" class="px-4 py-2 rounded-lg text-sm border border-amber-900/30 bg-amber-100 text-amber-900 hover:bg-amber-200">
            Pobierz kartę PDF
        </button>
        <form method="post" action="@Url.Action("Delete","Character")">
            <input type="hidden" name="id" value="@Model.Id" />
            <button type="submit" class="px-4 py-2 rounded-lg text-sm border border-red-900/30 bg-red-100 text-red-800 hover:bg-red-200">
                Usuń postać
            </button>
        </form>
    </div>

    <div class="grid gap-3 md:grid-cols-3 text-sm">
        <div class="bg-amber-50 border border-amber-900/15 rounded-lg p-3">STR: @Model.Strength</div>
        <div class="bg-amber-50 border border-amber-900/15 rounded-lg p-3">DEX: @Model.Dexterity</div>
        <div class="bg-amber-50 border border-amber-900/15 rounded-lg p-3">CON: @Model.Constitution</div>
        <div class="bg-amber-50 border border-amber-900/15 rounded-lg p-3">INT: @Model.Intelligence</div>
        <div class="bg-amber-50 border border-amber-900/15 rounded-lg p-3">WIS: @Model.Wisdom</div>
        <div class="bg-amber-50 border border-amber-900/15 rounded-lg p-3">CHA: @Model.Charisma</div>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
        <div>
            <h3 class="title-font text-lg text-amber-900 mb-2">Proficiencje</h3>
            <div class="flex flex-wrap gap-2 text-sm">
                @foreach (var p in profs) { <span class="px-3 py-1 bg-amber-100 text-amber-900 rounded-full border border-amber-900/20">@p</span> }
            </div>
        </div>
        <div>
            <h3 class="title-font text-lg text-amber-900 mb-2">Cechy rasowe</h3>
            <div class="flex flex-wrap gap-2 text-sm">
                @foreach (var t in traits) { <span class="px-3 py-1 bg-emerald-100 text-emerald-800 rounded-full border border-emerald-900/10">@t</span> }
            </div>
        </div>
    </div>

    <div>
        <h3 class="title-font text-lg text-amber-900 mb-2">Ekwipunek</h3>
        <ul class="space-y-1 text-sm">
        @if (Model.Items != null && Model.Items.Any())
        {
            foreach (var item in Model.Items)
            {
                <li class="flex justify-between bg-amber-50 border border-amber-900/15 rounded px-3 py-2">
                    <span>@item.Name</span>
                    <span class="text-amber-800">x @item.Quantity</span>
                </li>
            }
        }
        else
        {
            <li class="bg-amber-50 border border-amber-900/15 rounded px-3 py-2 text-amber-800 italic">
                Brak zapisanych przedmiotów.
            </li>
        }
        </ul>
        <div class="mt-4 flex gap-2">
            <a class="btn-primary px-3 py-2 rounded-lg text-sm border border-amber-900/30"
               href="@Url.Action("Equipment","Character", new { characterId  = Model.Id })">Zarządzaj</a>
        </div>
    </div>

    <form id="notesForm">
        <h3 class="title-font text-lg text-amber-900 mb-2">Notatki</h3>
        <input id="charId" name="charId" type="hidden" value="@Model.Id"/>
        <textarea id="notes" name="Notes" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg focus:ring focus:ring-amber-200 bg-white/90;" style="min-height:250px">@Model.Notes</textarea>
         <button onclick="saveNotes()" type="button" id="saveBtn" class="btn-primary px-5 py-3 rounded-xl text-sm font-semibold border border-amber-900/30">
            Zapisz notatki
        </button>
    </form>
</div>

@section Scripts {
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
    const avatarBtn = document.getElementById('generateAvatar');
    const avatarImg = document.getElementById('avatarPreview');

    // pokaż istniejący stabilny plik, jeśli dostępny
    avatarImg.addEventListener('load', () => {
        avatarImg.classList.remove('hidden');
        if (avatarBtn) avatarBtn.classList.add('hidden');
    });
    avatarImg.addEventListener('error', () => {
        avatarImg.classList.add('hidden');
        if (avatarBtn) avatarBtn.classList.remove('hidden');
    });

    avatarBtn?.addEventListener('click', async () => {
        avatarBtn.disabled = true;
        avatarBtn.textContent = 'Generowanie...';
        try {
            const res = await fetch('/api/avatar/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ characterId: @Model.Id })
            });
            if (!res.ok) {
                const txt = await res.text();
                let friendly = 'Nie udało się wygenerować awatara.';
                const lower = txt.toLowerCase();
                if (lower.includes('billing_hard_limit_reached')) {
                    friendly = 'Limit rozliczeń OpenAI został wyczerpany. Uzupełnij saldo i spróbuj ponownie.';
                } else if (lower.includes('invalid api key')) {
                    friendly = 'Klucz OpenAI jest nieprawidłowy lub wygasł.';
                } else if (lower.includes('model') && lower.includes('not found')) {
                    friendly = 'Model nie jest dostępny na Twoim koncie.';
                } else if (lower.includes('must be verified') && lower.includes('gpt-image-1')) {
                    friendly = 'Aby korzystać z gpt-image-1 (generowanie obrazów), zweryfikuj organizację w ustawieniach OpenAI i poczekaj do 15 minut.';
                } else {
                    friendly = `Błąd ${res.status}: ${txt}`;
                }
                alert(friendly);
                console.error('Avatar error status:', res.status);
                console.error('Avatar error body:', txt);
                return;
            }
            const data = await res.json();
            if (data.url) {
                avatarImg.src = data.url;
                avatarImg.classList.remove('hidden');
                avatarBtn.classList.add('hidden');
            }
        } catch (e) {
            alert('Problem z połączeniem do AI.');
        } finally {
            avatarBtn.disabled = false;
            avatarBtn.textContent = 'Wygeneruj awatar';
        }
    });

    async function saveNotes() {
        const notes = document.getElementById("notes").value;
        const charId = parseInt(document.getElementById("charId").value);
        console.log("notes: " + notes);
        console.log("charId: " + charId);
        try {
            const response = await fetch('/Character/SaveNotes?charId='+charId+"&notes="+notes, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            console.log(response);
            const result = await response.json();
            console.log(result);
            if (result === true) {
                alert("Notatka została zapisana!");
            } else {
                alert("Wystąpił błąd podczas zapisywania notatki.");
            }

        } catch (err) {
            console.error(err);
            alert("Błąd połączenia z serwerem.");
        }
    }
</script>
<script>
    const pdfButton = document.getElementById('downloadCharacterPdf');
    const pdfFields = @Html.Raw(JsonSerializer.Serialize(pdfFields));

    pdfButton?.addEventListener('click', async () => {
        const originalText = pdfButton.textContent;
        pdfButton.disabled = true;
        pdfButton.textContent = 'Generowanie...';
        try {
            const response = await fetch('/pdfs/5E_CharacterSheet_Fillable.pdf');
            if (!response.ok) {
                throw new Error('Brak pliku szablonu (pdfs/5E_CharacterSheet_Fillable.pdf).');
            }
            const existingPdfBytes = await response.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
            const form = pdfDoc.getForm();
            Object.entries(pdfFields).forEach(([key, value]) => {
                try {
                    const field = form.getField(key);
                    field.setText(value ?? '');
                } catch (err) {
                    console.warn('Nie można uzupełnić pola', key, err);
                }
            });
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${pdfFields.CharacterName || 'Bohater'}-karta.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(link.href), 1000);
        } catch (error) {
            console.error(error);
            alert('Nie udało się wygenerować PDF: ' + error.message);
        } finally {
            pdfButton.disabled = false;
            pdfButton.textContent = originalText;
        }
    });
</script>
}
