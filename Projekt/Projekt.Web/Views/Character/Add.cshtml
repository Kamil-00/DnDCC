@model Projekt.Model.DataModels.Character
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Nowa postac";
    var races = ViewData["Races"] as List<SelectListItem> ?? new();
    var classes = ViewData["Classes"] as List<SelectListItem> ?? new();
    var alignments = ViewData["Alignments"] as List<SelectListItem> ?? new();
}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-sm uppercase tracking-wide text-amber-700">Stworz bohatera</p>
            <h1 class="title-font text-3xl text-amber-900">Nowa postac</h1>
        </div>
        <div class="text-sm text-amber-800">
            Wybierz rase, klase i statystyki, a my pobierzemy profki i ekwipunek startowy.
        </div>
    </div>

    <form id="characterForm" class="space-y-4">
        <div>
            <label class="text-sm text-amber-900">Imie</label>
            <input name="Name" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg focus:ring focus:ring-amber-200 bg-white/90" />
        </div>
        <div class="grid gap-4 md:grid-cols-3">
            <div>
                <label class="text-sm text-amber-900">Rasa</label>
                <select id="race" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90">
                    @foreach (var r in races) { <option value="@r.Value">@r.Text</option> }
                </select>
            </div>
            <div>
                <label class="text-sm text-amber-900">Klasa</label>
                <select id="class" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90">
                    @foreach (var c in classes) { <option value="@c.Value">@c.Text</option> }
                </select>
            </div>
            <div>
                <label class="text-sm text-amber-900">Alignment</label>
                <select id="alignment" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90">
                    @foreach (var a in alignments) { <option value="@a.Value">@a.Text</option> }
                </select>
            </div>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
            <div><label class="text-sm text-amber-900">STR</label><input id="str" type="number" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" /></div>
            <div><label class="text-sm text-amber-900">DEX</label><input id="dex" type="number" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" /></div>
            <div><label class="text-sm text-amber-900">CON</label><input id="con" type="number" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" /></div>
        </div>
        <div class="grid gap-4 md:grid-cols-3">
            <div><label class="text-sm text-amber-900">INT</label><input id="int" type="number" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" /></div>
            <div><label class="text-sm text-amber-900">WIS</label><input id="wis" type="number" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" /></div>
            <div><label class="text-sm text-amber-900">CHA</label><input id="cha" type="number" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" /></div>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
            <div>
                <label class="text-sm text-amber-900">Proficiencje (z klasy)</label>
                <div id="proficienciesList" class="mt-2 space-y-2 text-sm text-amber-900 bg-white/70 border border-amber-900/15 rounded-lg p-3"></div>
            </div>
            <div>
                <label class="text-sm text-amber-900">Ekwipunek startowy</label>
                <div id="itemsList" class="mt-2 space-y-2 text-sm text-amber-900 bg-white/70 border border-amber-900/15 rounded-lg p-3"></div>
            </div>
        </div>

        <div id="formAlert" class="hidden rounded-lg border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm"></div>

        <button type="button" id="saveBtn" class="btn-primary px-5 py-3 rounded-xl text-sm font-semibold border border-amber-900/30">
            Zapisz postac
        </button>
    </form>
</div>

@section Scripts {
<script>
const saveBtn = document.getElementById('saveBtn');
const profList = document.getElementById('proficienciesList');
const itemsList = document.getElementById('itemsList');
const formAlert = document.getElementById('formAlert');

function showError(msg) {
  formAlert.textContent = msg;
  formAlert.classList.remove('hidden');
}

function clearError() {
  formAlert.textContent = '';
  formAlert.classList.add('hidden');
}

async function loadProficiencies(className) {
  profList.innerHTML = '<p class="text-amber-700">Ladowanie...</p>';
  try {
    const res = await fetch(`@Url.Action("GetProficiencies","Character")?className=${encodeURIComponent(className)}`);
    if (!res.ok) throw new Error('Blad pobierania proficiencies');
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      profList.innerHTML = '<p class="text-amber-700">Brak do wyboru</p>';
      return;
    }
    profList.innerHTML = data.map(p => `
      <label class="flex items-center gap-2">
        <input type="checkbox" value="${p.value}" class="proficiency-check accent-amber-700">
        <span>${p.text}</span>
      </label>
    `).join('');
  } catch (e) {
    profList.innerHTML = '<p class="text-red-700 text-sm">Nie udalo sie pobrac proficiencies.</p>';
  }
}

async function loadItems(className) {
  itemsList.innerHTML = '<p class="text-amber-700">Ladowanie...</p>';
  try {
    const res = await fetch(`@Url.Action("GetItems","Character")?className=${encodeURIComponent(className)}`);
    if (!res.ok) throw new Error('Blad pobierania ekwipunku');
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      itemsList.innerHTML = '<p class="text-amber-700">Brak opcji</p>';
      return;
    }
    itemsList.innerHTML = data.map((choice, idx) => {
      const sets = (choice.ItemSets || choice.itemSets || []);
      const options = sets.map((set) => {
        const regularItems = set.RegularItems || set.regularItems || [];
        const categoryItems = set.CategoryItems || set.categoryItems || [];
        const regular = regularItems.map(item => `<div class="text-sm text-amber-900">â€¢ ${item.Name ?? item.name} x ${item.Quantity ?? item.quantity}</div>`).join('');
        const category = categoryItems.map(item => `<option value="${item.Name ?? item.name}">${item.Name ?? item.name}</option>`).join('');
        const categorySelect = categoryItems.length
          ? `<select class="mt-1 px-2 py-1 border border-amber-900/20 rounded item-select bg-white/90" data-choice="${idx}">
                <option value="">Wybierz (${set.CategoryCount ?? set.categoryCount ?? 1})</option>
                ${category}
             </select>`
          : '';
        return `
          <div class="border border-amber-900/15 rounded-lg p-2 bg-amber-50">
            ${regular || '<div class="text-sm text-amber-700">Brak stalowych pozycji</div>'}
            ${categorySelect}
          </div>`;
      }).join('');
      return `
        <div class="border border-amber-900/20 rounded-lg p-3 bg-white/80">
          <div class="title-font text-amber-900 text-sm mb-2">${choice.Description ?? choice.description ?? 'Wybierz ekwipunek'}</div>
          <div class="space-y-2">${options}</div>
        </div>`;
    }).join('');
  } catch (e) {
    itemsList.innerHTML = '<p class="text-red-700 text-sm">Nie udalo sie pobrac ekwipunku.</p>';
  }
}

document.getElementById('class').addEventListener('change', (e) => {
  const cls = e.target.value;
  loadProficiencies(cls);
  loadItems(cls);
});

saveBtn.addEventListener('click', async () => {
  clearError();
  const name = document.querySelector('input[name="Name"]').value.trim();
  const race = document.getElementById('race').value;
  const cls = document.getElementById('class').value;
  const alignment = document.getElementById('alignment').value;
  const strength = +document.getElementById('str').value;
  const dexterity = +document.getElementById('dex').value;
  const constitution = +document.getElementById('con').value;
  const intelligence = +document.getElementById('int').value;
  const wisdom = +document.getElementById('wis').value;
  const charisma = +document.getElementById('cha').value;

  if (!name || !race || !cls || !alignment) {
    showError('Uzupelnij imie, rase, klase i alignment.');
    return;
  }

  const proficiencies = Array.from(document.querySelectorAll('.proficiency-check:checked')).map(i => i.value);
  const items = Array.from(document.querySelectorAll('.item-select'))
    .map(sel => sel.value)
    .filter(Boolean)
    .map(val => ({ name: val, quantity: 1 }));

  const payload = {
    character: {
      name,
      race,
      @Html.Raw("class"): cls,
      alignment,
      strength,
      dexterity,
      constitution,
      intelligence,
      wisdom,
      charisma,
      subClass: "",
      spells: "",
      proficiencies: [],
      traits: [],
      items: []
    },
    proficiencies,
    items
  };

  try {
    const res = await fetch('@Url.Action("Add","Character")', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      showError('Blad zapisu postaci.');
      return;
    }
    const data = await res.json();
    window.location = data.redirectUrl;
  } catch (e) {
    showError('Blad polaczenia podczas zapisu.');
  }
});

document.addEventListener('DOMContentLoaded', () => {
  const cls = document.getElementById('class').value;
  if (cls) {
    loadProficiencies(cls);
    loadItems(cls);
  }
});
</script>
}
