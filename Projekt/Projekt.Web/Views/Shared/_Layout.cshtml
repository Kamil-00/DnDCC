<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - DnDCC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        :root {
            --bg: linear-gradient(135deg, #0c0a0f 0%, #1c1726 45%, #2d1b1b 100%);
            --panel: #f6f0e5;
            --panel-border: #d7c9b8;
            --accent: #c89b4f;
            --accent-dark: #4e2f1f;
        }
        body {
            font-family: 'Crimson Pro', serif;
            background: center/cover no-repeat url('/images/tlo.jpg'), var(--bg);
            color: #1f140d;
        }
        .title-font { font-family: 'Cinzel', serif; letter-spacing: 0.03em; }
        .parchment {
            background: var(--panel);
            box-shadow: 0 12px 32px rgba(0,0,0,0.35);
            border: 1px solid var(--panel-border);
        }
        .nav-link { transition: color .2s ease, transform .2s ease; }
        .nav-link:hover { color: var(--accent); transform: translateY(-1px); }
        .btn-primary {
            background: linear-gradient(135deg, #b68946, #d6b06b);
            color: #2b1c10;
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .btn-primary:hover { filter: brightness(1.05); }
        .modal-backdrop { background: rgba(0,0,0,0.65); }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="border-b border-amber-900/30 bg-black/40 backdrop-blur sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between text-amber-100">
            <a href="@Url.Action("Index","Home")" class="title-font text-xl tracking-wide">DnDCC</a>
            <nav id="mainNav" class="grid gap-3 text-sm uppercase tracking-wide items-center">
                <!-- Links będą dynamicznie dodawane przez JavaScript -->
                <a class="nav-link text-center px-3 py-2 rounded-lg border border-amber-900/40 bg-black/30 whitespace-nowrap min-w-[140px]" href="@Url.Action("Index","Home")">Podręczniki</a>
                <a id="navMyCharacters" class="nav-link text-center px-3 py-2 rounded-lg border border-amber-900/40 bg-black/30 whitespace-nowrap min-w-[140px] hidden" href="@Url.Action("Index","Character")">Moje postacie</a>
                <a id="navCreateCharacter" class="nav-link text-center px-3 py-2 rounded-lg border border-amber-900/40 bg-black/30 whitespace-nowrap min-w-[140px] hidden" href="@Url.Action("Add","Character")">Stwórz postać</a>
                <button id="authButton" class="nav-link text-center px-3 py-2 rounded-lg border border-amber-900/40 bg-black/30 whitespace-nowrap min-w-[140px] flex items-center justify-center gap-2">
                    <img src="/images/konto.webp" alt="konto" class="w-4 h-4">
                    <span id="authButtonText">LOGOWANIE/REJESTRACJA</span>
                </button>
            </nav>
        </div>
    </header>
    <main class="flex-1 max-w-6xl mx-auto px-4 py-8">
        <div class="parchment rounded-2xl p-6 md:p-8">
            @RenderBody()
        </div>
    </main>
    <footer class="h-[30px] bg-black text-amber-100 flex items-center justify-center text-xs">
        © 2025 All rights reserved by DnDCC. v 1.0
    </footer>

    <!-- Modal auth (login & register) -->
    <div id="authModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center px-4">
        <div class="parchment rounded-2xl w-full max-w-lg relative p-6">
            <button id="closeAuth" class="absolute right-4 top-3 text-amber-800 hover:text-red-700 text-2xl leading-none">&times;</button>
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-sm uppercase tracking-wide text-amber-700">Gildia bohaterów</p>
                    <h2 id="authTitle" class="title-font text-2xl text-amber-900">Zaloguj się</h2>
                    <p id="authSubtitle" class="text-sm text-amber-800">Podaj login/email i hasło.</p>
                </div>
                <button id="toggleAuth" class="text-sm text-amber-900 underline">Przełącz na rejestrację</button>
            </div>

            <div class="space-y-3" id="authFields">
                <!-- LOGIN/REGISTER FIELDS -->
                <div>
                    <label class="text-sm text-amber-900">Login lub email</label>
                    <input id="authUser" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                </div>
                <div id="authEmailRow" class="hidden">
                    <label class="text-sm text-amber-900">Email</label>
                    <input id="authEmail" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                </div>
                <div class="grid gap-3 md:grid-cols-2 hidden" id="authNameRow">
                    <div>
                        <label class="text-sm text-amber-900">Imię</label>
                        <input id="authFirst" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                    </div>
                    <div>
                        <label class="text-sm text-amber-900">Nazwisko</label>
                        <input id="authLast" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                    </div>
                </div>
                <div>
                    <label class="text-sm text-amber-900">Hasło</label>
                    <input id="authPass" type="password" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                </div>
                <!-- Forgot password link -->
                <div class="text-right">
                    <button id="forgotPassLink" class="text-xs text-amber-800 underline">Zapomniałeś hasła?</button>
                </div>

                <div id="authAlert" class="hidden rounded-lg border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm"></div>
                <button id="authSubmit" class="btn-primary w-full py-3 rounded-xl text-sm font-semibold border border-amber-900/30">
                    Wyślij
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: forgot/reset password -->
    <div id="passwordModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center px-4">
        <div class="parchment rounded-2xl w-full max-w-lg relative p-6">
            <button id="closePasswordModal" class="absolute right-4 top-3 text-amber-800 hover:text-red-700 text-2xl leading-none">&times;</button>
            <div class="mb-4">
                <p class="text-sm uppercase tracking-wide text-amber-700">Reset hasła</p>
                <h2 id="passwordModalTitle" class="title-font text-2xl text-amber-900">Wyślij link resetujący</h2>
                <p id="passwordModalSubtitle" class="text-sm text-amber-800">Podaj email konta, a wyślemy token resetu (w wersji dev wypisany jest na konsoli).'</p>
            </div>

            <!-- Step 1: request token -->
            <div id="forgotStep" class="space-y-3">
                <div>
                    <label class="text-sm text-amber-900">Email</label>
                    <input id="forgotEmail" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                </div>
                <div id="forgotAlert" class="hidden rounded-lg border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm"></div>
                <button id="sendResetTokenBtn" class="btn-primary w-full py-3 rounded-xl text-sm font-semibold border border-amber-900/30">Wyślij token</button>

                <div class="text-sm text-amber-800">
                    Masz już token? <button id="goToResetStep" class="underline">Przejdź do zmiany hasła</button>
                </div>
            </div>

            <!-- Step 2: reset password with token -->
            <div id="resetStep" class="space-y-3 hidden">
                <div>
                    <label class="text-sm text-amber-900">Email</label>
                    <input id="resetEmail" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                </div>
                <div>
                    <label class="text-sm text-amber-900">Token resetu</label>
                    <input id="resetToken" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                </div>
                <div>
                    <label class="text-sm text-amber-900">Nowe hasło</label>
                    <input id="resetNewPassword" type="password" class="w-full mt-1 px-3 py-2 border border-amber-900/20 rounded-lg bg-white/90" />
                </div>
                <div id="resetAlert" class="hidden rounded-lg border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm"></div>
                <button id="resetPasswordBtn" class="btn-primary w-full py-3 rounded-xl text-sm font-semibold border border-amber-900/30">Ustaw nowe hasło</button>

                <div class="text-sm text-amber-800">
                    Nie masz tokenu? <button id="goToForgotStep" class="underline">Wyślij token ponownie</button>
                </div>
            </div>
        </div>
    </div>

    @RenderSection("Scripts", required: false)
    <script>
        const authButton = document.getElementById('authButton');
        const authButtonText = document.getElementById('authButtonText');
        const authModal = document.getElementById('authModal');
        const userModal = document.getElementById('userModal');
        const closeAuthBtn = document.getElementById('closeAuth');
        const closeUserBtn = document.getElementById('closeUser');
        const toggleAuthBtn = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        const authSubtitle = document.getElementById('authSubtitle');
        const authEmailRow = document.getElementById('authEmailRow');
        const authNameRow = document.getElementById('authNameRow');
        const authSubmit = document.getElementById('authSubmit');
        const authAlert = document.getElementById('authAlert');
        const logoutBtn = document.getElementById('logoutBtn');
        const userFullName = document.getElementById('userFullName');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const mainNav = document.getElementById('mainNav');
        const navMyCharacters = document.getElementById('navMyCharacters');
        const navCreateCharacter = document.getElementById('navCreateCharacter');
        const forgotPassLink = document.getElementById('forgotPassLink');
        const passwordModal = document.getElementById('passwordModal');
        const closePasswordModal = document.getElementById('closePasswordModal');
        const forgotStep = document.getElementById('forgotStep');
        const resetStep = document.getElementById('resetStep');
        const passwordModalTitle = document.getElementById('passwordModalTitle');
        const passwordModalSubtitle = document.getElementById('passwordModalSubtitle');

        const sendResetTokenBtn = document.getElementById('sendResetTokenBtn');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        const forgotEmail = document.getElementById('forgotEmail');
        const resetEmail = document.getElementById('resetEmail');
        const resetToken = document.getElementById('resetToken');
        const resetNewPassword = document.getElementById('resetNewPassword');
        const forgotAlert = document.getElementById('forgotAlert');
        const resetAlert = document.getElementById('resetAlert');

        let mode = 'login';
        let currentUser = null;

        const fields = {
            user: document.getElementById('authUser'),
            email: document.getElementById('authEmail'),
            first: document.getElementById('authFirst'),
            last: document.getElementById('authLast'),
            pass: document.getElementById('authPass')
        };

        function updateNavigation() {
            if (currentUser) {
                mainNav.classList.remove('grid-cols-2');
                mainNav.classList.add('grid-cols-4');
                navMyCharacters.classList.remove('hidden');
                navCreateCharacter.classList.remove('hidden');
            } else {
                mainNav.classList.remove('grid-cols-4');
                mainNav.classList.add('grid-cols-2');
                navMyCharacters.classList.add('hidden');
                navCreateCharacter.classList.add('hidden');
            }
        }

        function checkAuth() {
            const userData = localStorage.getItem('user');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateUIForLoggedIn();
            }
            updateNavigation();
        }

        function updateUIForLoggedIn() {
            if (currentUser) {
                authButtonText.textContent = currentUser.userName.toUpperCase();
                userFullName.textContent = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.userName;
                userNameDisplay.textContent = currentUser.userName;
            }
        }

        function setMode(newMode) {
            mode = newMode;
            if (mode === 'login') {
                authTitle.textContent = 'Zaloguj się';
                authSubtitle.textContent = 'Podaj login/email i hasło.';
                authEmailRow.classList.add('hidden');
                authNameRow.classList.add('hidden');
                toggleAuthBtn.textContent = 'Przełącz na rejestrację';
            } else {
                authTitle.textContent = 'Załóż konto';
                authSubtitle.textContent = 'Wypełnij dane nowego bohatera.';
                authEmailRow.classList.remove('hidden');
                authNameRow.classList.remove('hidden');
                toggleAuthBtn.textContent = 'Przełącz na logowanie';
            }
            clearAuthError();
            clearFields();
        }

        function clearFields() {
            fields.user.value = '';
            fields.email.value = '';
            fields.first.value = '';
            fields.last.value = '';
            fields.pass.value = '';
        }

        function showAuthError(msg) {
            authAlert.textContent = msg;
            authAlert.classList.remove('hidden');
        }

        function clearAuthError() {
            authAlert.textContent = '';
            authAlert.classList.add('hidden');
        }

        function showForgot() {
            passwordModalTitle.textContent = 'Wyślij link resetujący';
            passwordModalSubtitle.textContent = 'Podaj email konta, a wyślemy token resetu (w wersji dev wypisany jest na konsoli).';
            forgotStep.classList.remove('hidden');
            resetStep.classList.add('hidden');
        }
        function showReset() {
            passwordModalTitle.textContent = 'Ustaw nowe hasło';
            passwordModalSubtitle.textContent = 'Wpisz email, token resetu i nowe hasło.';
            resetStep.classList.remove('hidden');
            forgotStep.classList.add('hidden');
        }
        function alertForgot(msg) {
            forgotAlert.textContent = msg;
            forgotAlert.classList.remove('hidden');
        }
        function alertReset(msg) {
            resetAlert.textContent = msg;
            resetAlert.classList.remove('hidden');
        }
        function clearForgotAlert() { forgotAlert.textContent = ''; forgotAlert.classList.add('hidden'); }
        function clearResetAlert() { resetAlert.textContent = ''; resetAlert.classList.add('hidden'); }

        authButton?.addEventListener('click', () => {
            if (currentUser) {
                userModal.classList.remove('hidden');
            } else {
                setMode('login');
                authModal.classList.remove('hidden');
            }
        });

        closeAuthBtn?.addEventListener('click', () => authModal.classList.add('hidden'));
        closeUserBtn?.addEventListener('click', () => userModal.classList.add('hidden'));
        authModal?.addEventListener('click', (e) => { if (e.target === authModal) authModal.classList.add('hidden'); });
        userModal?.addEventListener('click', (e) => { if (e.target === userModal) userModal.classList.add('hidden'); });
        toggleAuthBtn?.addEventListener('click', () => setMode(mode === 'login' ? 'register' : 'login'));

        logoutBtn?.addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (e) {
                console.error('Logout error:', e);
            }
            localStorage.removeItem('user');
            currentUser = null;
            authButtonText.textContent = 'LOGOWANIE/REJESTRACJA';
            userModal.classList.add('hidden');
            updateNavigation();
            location.href = '@Url.Action("Index","Home")';
        });

        authSubmit?.addEventListener('click', async () => {
            clearAuthError();
            const user = fields.user?.value.trim();
            const pass = fields.pass?.value;

            if (!user || !pass) {
                showAuthError('Podaj login/email i hasło.');
                return;
            }

            authSubmit.disabled = true;
            authSubmit.textContent = 'Przetwarzanie...';

            if (mode === 'login') {
                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userNameOrEmail: user, password: pass })
                    });

                    if (!res.ok) {
                        const data = await res.json().catch(() => ({}));
                        showAuthError(data.error || 'Błędne dane logowania.');
                        return;
                    }

                    const result = await res.json();
                    localStorage.setItem('user', JSON.stringify(result));
                    currentUser = result;
                    updateUIForLoggedIn();
                    updateNavigation();
                    authModal.classList.add('hidden');
                    clearFields();
                } catch (err) {
                    console.error('Login error:', err);
                    showAuthError('Problem z połączeniem.');
                } finally {
                    authSubmit.disabled = false;
                    authSubmit.textContent = 'Wyślij';
                }
            } else {
                const email = fields.email?.value.trim();
                const first = fields.first?.value.trim();
                const last = fields.last?.value.trim();

                if (!email || !first || !last) {
                    showAuthError('Uzupełnij wszystkie pola.');
                    authSubmit.disabled = false;
                    authSubmit.textContent = 'Wyślij';
                    return;
                }

                try {
                    const res = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userName: user,
                            email: email,
                            firstName: first,
                            lastName: last,
                            password: pass,
                            isPremium: false
                        })
                    });

                    if (!res.ok) {
                        const data = await res.json().catch(() => ({}));
                        showAuthError(data.error || 'Nie udało się założyć konta.');
                        return;
                    }

                    const result = await res.json();
                    localStorage.setItem('user', JSON.stringify(result));
                    currentUser = result;
                    updateUIForLoggedIn();
                    updateNavigation();
                    authModal.classList.add('hidden');
                    clearFields();
                } catch (err) {
                    console.error('Register error:', err);
                    showAuthError('Problem z połączeniem.');
                } finally {
                    authSubmit.disabled = false;
                    authSubmit.textContent = 'Wyślij';
                }
            }
        });

        forgotPassLink?.addEventListener('click', () => { showForgot(); passwordModal.classList.remove('hidden'); });
        closePasswordModal?.addEventListener('click', () => { passwordModal.classList.add('hidden'); });

        document.getElementById('goToResetStep')?.addEventListener('click', showReset);
        document.getElementById('goToForgotStep')?.addEventListener('click', showForgot);

        sendResetTokenBtn?.addEventListener('click', async () => {
            clearForgotAlert();
            const email = forgotEmail.value.trim();
            if (!email) { alertForgot('Podaj email.'); return; }
            sendResetTokenBtn.disabled = true;
            sendResetTokenBtn.textContent = 'Wysyłanie...';
            try {
                const res = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    alertForgot(data.error || 'Błąd wysyłania tokenu.');
                    return;
                }
                alertForgot('Token został wysłany (sprawdź konsolę serwera).');
                forgotAlert.classList.remove('text-red-700', 'bg-red-50', 'border-red-200');
                forgotAlert.classList.add('text-green-700', 'bg-green-50', 'border-green-200');
            } catch (e) {
                alertForgot('Problem z połączeniem.');
            } finally {
                sendResetTokenBtn.disabled = false;
                sendResetTokenBtn.textContent = 'Wyślij token';
            }
        });

        resetPasswordBtn?.addEventListener('click', async () => {
            clearResetAlert();
            const email = resetEmail.value.trim();
            const token = resetToken.value.trim();
            const newPassword = resetNewPassword.value;
            if (!email || !token || !newPassword) { alertReset('Uzupełnij wszystkie pola.'); return; }
            resetPasswordBtn.disabled = true;
            resetPasswordBtn.textContent = 'Przetwarzanie...';
            try {
                const res = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userNameOrEmail: email, token, newPassword })
                });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    alertReset(data.error || 'Nie udało się zresetować hasła.');
                    return;
                }
                alertReset('Hasło zostało zaktualizowane. Możesz się zalogować.');
                resetAlert.classList.remove('text-red-700', 'bg-red-50', 'border-red-200');
                resetAlert.classList.add('text-green-700', 'bg-green-50', 'border-green-200');
            } catch (e) {
                alertReset('Problem z połączeniem.');
            } finally {
                resetPasswordBtn.disabled = false;
                resetPasswordBtn.textContent = 'Ustaw nowe hasło';
            }
        });

        checkAuth();
    </script>
</body>
</html>